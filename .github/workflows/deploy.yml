name: Deploy to GitHub Pages

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:  # Manual trigger

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: github-pages
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Setup GitHub Pages
        uses: actions/configure-pages@v3
        
      - name: Inject Gemini API Key
        run: |
          # Buat file gemini-config.js dari template
          if [ -f "assets/js/gemini-config.template.js" ]; then
            # Copy template
            cp assets/js/gemini-config.template.js assets/js/gemini-config.js
            
            # Inject API Key dari GitHub Secrets
            if [ -n "${{ secrets.GEMINI_API_KEY }}" ]; then
              # Escape special characters untuk sed
              API_KEY=$(echo "${{ secrets.GEMINI_API_KEY }}" | sed 's/[&/\]/\\&/g')
              sed -i "s/{{GEMINI_API_KEY}}/${API_KEY}/g" assets/js/gemini-config.js
              
              # Tampilkan info tanpa menampilkan key
              KEY_LENGTH=${#API_KEY}
              echo "‚úÖ API Key berhasil di-inject (panjang: ${KEY_LENGTH} karakter)"
              echo "üîí API Key aman tersimpan di GitHub Secrets"
            else
              echo "‚ö†Ô∏è PERINGATAN: GEMINI_API_KEY tidak ditemukan di GitHub Secrets"
              echo "‚ö†Ô∏è Fitur AI akan dinonaktifkan di website production"
              echo "‚ÑπÔ∏è Untuk menggunakan fitur AI, tambahkan secret di:"
              echo "   Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí New repository secret"
            fi
          else
            echo "‚ùå ERROR: Template file gemini-config.template.js tidak ditemukan"
            echo "‚ùå Pastikan file ada di: assets/js/gemini-config.template.js"
            exit 1
          fi
          
          # Verifikasi file berhasil dibuat
          if [ -f "assets/js/gemini-config.js" ]; then
            echo "‚úÖ File config berhasil dibuat: assets/js/gemini-config.js"
          else
            echo "‚ùå ERROR: Gagal membuat gemini-config.js"
            exit 1
          fi
          
      - name: Setup Pages
        uses: actions/configure-pages@v3
        
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v2
        with:
          path: '.'
          
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v2
