name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Manual trigger

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      # Step 1: Checkout code
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # Hemat bandwidth
          
      # Step 2: Setup Pages (hanya sekali)
      - name: Setup Pages
        uses: actions/configure-pages@v4
        
      # Step 3: Inject API Key
      - name: Inject Gemini API Key
        run: |
          echo "ğŸ”§ Injecting API Key..."
          
          # Cek apakah template file ada
          if [ ! -f "assets/js/gemini-config.template.js" ]; then
            echo "âŒ ERROR: Template file tidak ditemukan!"
            echo "ğŸ“ Current directory:"
            ls -la
            echo "ğŸ“ assets/js/ directory:"
            ls -la assets/js/ || echo "assets/js/ tidak ada"
            exit 1
          fi
          
          # Buat file config dari template
          cp assets/js/gemini-config.template.js assets/js/gemini-config.js
          
          # Inject API Key jika ada
          if [ -n "${{ secrets.GEMINI_API_KEY }}" ]; then
            echo "ğŸ”‘ API Key ditemukan, melakukan injection..."
            
            # Gunakan @ sebagai delimiter untuk menghindari escape issues
            sed -i "s|{{GEMINI_API_KEY}}|${{ secrets.GEMINI_API_KEY }}|g" assets/js/gemini-config.js
            
            # Verifikasi perubahan
            if grep -q "AIzaSy" assets/js/gemini-config.js; then
              echo "âœ… API Key berhasil di-inject"
              echo "ğŸ“Š Panjang API Key: $(wc -c < assets/js/gemini-config.js) bytes"
            else
              echo "âš ï¸ Warning: API Key mungkin tidak ter-inject dengan benar"
            fi
          else
            echo "âš ï¸ WARNING: GEMINI_API_KEY tidak ditemukan di GitHub Secrets"
            echo "â„¹ï¸ Fitur AI akan disabled di production"
            echo "ğŸ“ Untuk setup, buka: Settings > Secrets and variables > Actions"
          fi
          
          # Tampilkan preview file (tanpa key lengkap)
          echo "ğŸ“„ File config berhasil dibuat:"
          head -5 assets/js/gemini-config.js
          
      # Step 4: Upload artifact dengan path yang benar
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'  # Upload seluruh folder
      # Step 5: Deploy
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
